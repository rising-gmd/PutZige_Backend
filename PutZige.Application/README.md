# PutZige.Application

Application layer containing business logic, use cases, DTOs, and service interfaces. This project depends on the `PutZige.Domain` layer and exposes interfaces implemented by the infrastructure layer.

## Table of contents

- [Principles](#principles)
- [Structure](#structure)
- [Patterns used](#patterns-used)
- [Key components](#key-components)
- [DTOs](#dtos)
- [Validators](#validators)
- [Mappings](#mappings)
- [Authentication (JWT)](#authentication-jwt)
- [Tests](#tests)
- [Dependencies](#dependencies)
- [Usage examples](#usage-examples)
- [Related READMEs](#related-readmes)

## Principles

- Use-case driven services
- Dependency inversion: define interfaces here, implement in Infrastructure
- Separate commands and queries when beneficial
- Keep domain entities inside the Domain layer; map to DTOs for outward-facing contracts

## Structure

```
PutZige.Application/
  DTOs/
  Interfaces/
  Services/
  Validators/
  Mappings/
  Settings/
  DependencyInjection.cs
```

## Patterns used

- FluentValidation for request validation
- AutoMapper for mapping domain entities to DTOs
- Services expose DTOs; repositories are injected via interfaces
- Api responses use `ApiResponse<T>` wrapper returned by controllers

## Key components

- `IUserService` / `UserService` - user related business logic
- `IAuthService` / `AuthService` - authentication (login / refresh)
- DTOs for auth flows under `DTOs/Auth/`
 - `IMessagingService` / `MessagingService` - messaging business logic (send, conversation history, mark delivered/read)

## DTOs

Auth-related DTOs implemented in `PutZige.Application/DTOs/Auth`:
- `LoginRequest` (email, password)
- `LoginResponse` (access token, refresh token, expiresIn, user info)
- `RefreshTokenRequest` (refreshToken)
- `RefreshTokenResponse` (new access token, refresh token)

## Validators

Validators use FluentValidation and are discovered by DI. Notable validator:
- `LoginRequestValidator` - validates email and password and uses `.WithName("email")` / `.WithName("password")` so model errors appear with lowercase field names.

## Mappings

AutoMapper profiles are located in `PutZige.Application/Mappings`. Example:
- `AuthMappingProfile` maps `PutZige.Domain.Entities.User` to `LoginResponse`.
AutoMapper is registered by `DependencyInjection.AddApplicationServices()`.

## Authentication (JWT)

This layer defines the settings contract for JWT and the `IAuthService` interface. Key points:
- `JwtSettings` is defined under `PutZige.Application.Settings` and contains: `Secret`, `Issuer`, `Audience`, `AccessTokenExpiryMinutes`, `RefreshTokenExpiryDays`.
- `IAuthService` exposes `LoginAsync` and `RefreshTokenAsync` used by API controllers.
- Tokens are generated by an infrastructure implementation of `IJwtTokenService` but the settings and DTOs live in the Application layer.

Usage notes:
- All async methods accept `CancellationToken`.
- Services follow constructor null-check patterns and provide concise one-line logging for important events (login attempts, failures, success).

## Tests

Unit tests for application services and validators are in `PutZige.Application.Tests`:
- `Services/AuthServiceTests.cs` - comprehensive unit tests for login and refresh flows, including lockout behavior.
- `Validators/LoginRequestValidatorTests.cs` - validator unit tests.

Run unit tests:
```
dotnet test PutZige.Application.Tests
```

## Dependencies

- `FluentValidation`
- `AutoMapper`
- `BCrypt.Net-Next` used by services for password hashing/verification

## Usage examples

Auth service usage (simplified):
```csharp
var response = await _authService.LoginAsync(email, password, ipAddress, cancellationToken);
```

## Related READMEs
- `../PutZige.API/README.md`
- `../PutZige.Infrastructure/README.md`
- `../PutZige.Domain/README.md`
